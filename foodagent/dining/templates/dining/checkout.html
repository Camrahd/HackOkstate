{% load static %}
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Checkout ‚Ä¢ Crave</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .card{transition:transform .15s ease, box-shadow .15s ease}
    .card:hover{transform:translateY(-2px); box-shadow:0 10px 28px rgba(0,0,0,.08)}
    .pill input:checked + label{background:#111;color:#fff}
    .btn-disabled{opacity:.5; cursor:not-allowed}
  </style>
</head>
<body class="bg-gradient-to-b from-amber-50 to-white text-gray-900">
  <div class="max-w-6xl mx-auto px-4 py-6">
    <div class="flex items-center justify-between">
      <a href="/" class="text-sm text-gray-600">‚Üê Continue browsing</a>
      <div class="text-sm text-gray-500">Secure checkout</div>
    </div>

    <h1 class="text-3xl font-extrabold mt-3">Review & Checkout</h1>

    <div class="grid lg:grid-cols-3 gap-6 mt-6">
      <!-- Left: Items -->
      <div class="lg:col-span-2 space-y-4">
        <!-- Fulfillment -->
        <div class="bg-white rounded-2xl border card p-4">
          <div class="font-semibold">How would you like to get your order?</div>
          <div class="mt-3 flex gap-2 pill">
            <input class="hidden" type="radio" name="fulfillment" id="opt-pickup" value="pickup" checked>
            <label for="opt-pickup" class="px-3 py-2 rounded-xl border cursor-pointer">Pickup</label>
            <input class="hidden" type="radio" name="fulfillment" id="opt-delivery" value="delivery">
            <label for="opt-delivery" class="px-3 py-2 rounded-xl border cursor-pointer">Delivery</label>
          </div>
          <p class="text-xs text-gray-500 mt-2">Delivery adds a small fee and requires an address.</p>

          <!-- Address form (hidden unless Delivery) -->
          <div id="addr" class="mt-4 hidden">
            <div class="grid md:grid-cols-2 gap-3">
              <div>
                <label class="text-xs text-gray-600">Full name</label>
                <input id="name" class="mt-1 w-full px-3 py-2 rounded-xl border" placeholder="Your name" />
              </div>
              <div>
                <label class="text-xs text-gray-600">Phone</label>
                <input id="phone" class="mt-1 w-full px-3 py-2 rounded-xl border" placeholder="(555) 555-5555" />
              </div>
              <div class="md:col-span-2">
                <label class="text-xs text-gray-600">Address line 1</label>
                <input id="line1" class="mt-1 w-full px-3 py-2 rounded-xl border" placeholder="123 Main St" />
              </div>
              <div class="md:col-span-2">
                <label class="text-xs text-gray-600">Address line 2 <span class="text-gray-400">(optional)</span></label>
                <input id="line2" class="mt-1 w-full px-3 py-2 rounded-xl border" placeholder="Apt, suite, etc." />
              </div>
              <div>
                <label class="text-xs text-gray-600">City</label>
                <input id="city" class="mt-1 w-full px-3 py-2 rounded-xl border" placeholder="City" />
              </div>
              <div>
                <label class="text-xs text-gray-600">State</label>
                <input id="state" class="mt-1 w-full px-3 py-2 rounded-xl border" placeholder="State" />
              </div>
              <div>
                <label class="text-xs text-gray-600">Postal code</label>
                <input id="postal" class="mt-1 w-full px-3 py-2 rounded-xl border" placeholder="ZIP" />
              </div>
            </div>
            <div class="mt-3">
              <label class="text-xs text-gray-600">Notes for the kitchen <span class="text-gray-400">(optional)</span></label>
              <textarea id="notes" class="mt-1 w-full px-3 py-2 rounded-xl border" rows="2" placeholder="Add extra requests or delivery notes"></textarea>
            </div>
          </div>
        </div>

        <!-- Items list -->
        <div class="bg-white rounded-2xl border card">
          <div class="p-4 border-b font-semibold">Your items</div>
          <div id="items" class="divide-y">
            {% for it in items %}
            <div class="p-4 flex items-center justify-between gap-4" data-item-id="{{ it.id }}" data-price="{{ it.menu_item.price }}">
              <div class="flex items-start gap-3">
                <div class="w-16 h-16 rounded-xl bg-amber-100 flex items-center justify-center">üçΩÔ∏è</div>
                <div>
                  <div class="font-medium">{{ it.menu_item.name }}</div>
                  <div class="text-xs text-gray-500">${{ it.menu_item.price }} each</div>
                </div>
              </div>
              <div class="flex items-center gap-3">
                <div class="inline-flex items-center border rounded-xl">
                  <button class="px-3 py-1 text-lg qty-dec" type="button">‚àí</button>
                  <input class="w-10 text-center outline-none" inputmode="numeric" value="{{ it.qty }}" />
                  <button class="px-3 py-1 text-lg qty-inc" type="button">Ôºã</button>
                </div>
                <button class="text-red-600 hover:underline del" type="button">Remove</button>
              </div>
            </div>
            {% empty %}
            <div class="p-4 text-sm text-gray-600">Your cart is empty.</div>
            {% endfor %}
          </div>
        </div>
      </div>

      <!-- Right: Summary / Pay -->
      <div>
        <div class="bg-white rounded-2xl border card p-4">
          <div class="font-semibold">Order summary</div>
          <div class="mt-3 space-y-2 text-sm" id="summary">
            <div class="flex justify-between"><span>Subtotal</span><span id="sum-sub">${{ subtotal }}</span></div>
            <div class="flex justify-between"><span>Tax (est.)</span><span id="sum-tax">${{ tax }}</span></div>
            <div class="flex justify-between hidden" id="row-fee"><span>Delivery fee</span><span id="sum-fee">$3.50</span></div>
            <div class="flex justify-between font-semibold border-t pt-2"><span>Total</span><span id="sum-total">${{ total }}</span></div>
          </div>

          <div class="mt-4">
            {% if user.is_authenticated %}
            <button id="pay" class="w-full px-4 py-3 rounded-2xl bg-black text-white">Pay now</button>
            {% else %}
            <div class="text-sm text-gray-600 mb-2">Please sign in to checkout.</div>
            <a href="/accounts/google/login/?process=login&next=/cart/"
               class="w-full inline-flex justify-center px-4 py-3 rounded-2xl border">Continue with Google</a>
            <a href="/accounts/login/?next=/cart/"
               class="mt-2 w-full inline-flex justify-center px-4 py-3 rounded-2xl bg-black text-white">Email login</a>
            {% endif %}
          </div>

          <details class="mt-4">
            <summary class="cursor-pointer text-sm font-semibold">Or scan to pay on your phone</summary>
            <div class="mt-3">
              <img id="qr" class="w-full rounded-xl border" alt="QR code"/>
              <a id="checkout-link" class="mt-2 inline-flex w-full justify-center px-3 py-2 rounded-xl border" target="_blank">Open Checkout</a>
            </div>
          </details>

          <div id="msg" class="text-sm text-red-600 mt-3"></div>
        </div>

        <div class="mt-4 text-xs text-gray-500">
          <div>By paying, you agree to our <a href="#" class="underline">Terms</a> and <a href="#" class="underline">Privacy Policy</a>.</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // CSRF helper
    function getCookie(name){
      return document.cookie.split('; ').find(r => r.startsWith(name+'='))?.split('=')[1];
    }
    const csrftoken = getCookie('csrftoken');

    const formatMoney = (n)=>'$'+(Math.round(n*100)/100).toFixed(2);

    const itemsRoot = document.getElementById('items');
    const sumSub = document.getElementById('sum-sub');
    const sumTax = document.getElementById('sum-tax');
    const sumFee = document.getElementById('sum-fee');
    const rowFee = document.getElementById('row-fee');
    const sumTotal = document.getElementById('sum-total');
    const payBtn = document.getElementById('pay');
    const msg = document.getElementById('msg');

    const DELIVERY_FEE = 3.50;

    function currentFulfillment(){
      return document.getElementById('opt-delivery').checked ? 'delivery' : 'pickup';
    }

    function cartIsEmpty(){
      return itemsRoot.querySelectorAll('[data-item-id]').length === 0;
    }

    function updatePayDisabled(){
      if (!payBtn) return;
      const empty = cartIsEmpty();
      payBtn.disabled = empty;
      payBtn.classList.toggle('btn-disabled', empty);
      payBtn.classList.toggle('opacity-50', empty);
    }

    function recalc(){
      let subtotal = 0;
      itemsRoot.querySelectorAll('[data-item-id]').forEach(row=>{
        const price = parseFloat(row.getAttribute('data-price')) || 0;
        const qty = Math.max(0, parseInt(row.querySelector('input').value || '0', 10));
        subtotal += price * qty;
      });
      const tax = +(subtotal * 0.08).toFixed(2);
      const fee = currentFulfillment()==='delivery' ? DELIVERY_FEE : 0;
      sumSub.textContent = formatMoney(subtotal);
      sumTax.textContent = formatMoney(tax);
      sumFee.textContent = formatMoney(fee);
      rowFee.classList.toggle('hidden', fee===0);
      sumTotal.textContent = formatMoney(subtotal + tax + fee);
      updatePayDisabled();
    }

    // Toggle address visibility
    document.getElementById('opt-pickup').addEventListener('change', ()=>{
      document.getElementById('addr').classList.add('hidden');
      recalc();
    });
    document.getElementById('opt-delivery').addEventListener('change', ()=>{
      document.getElementById('addr').classList.remove('hidden');
      recalc();
    });

    // Qty & delete actions
    itemsRoot.addEventListener('click', async (e)=>{
      const row = e.target.closest('[data-item-id]');
      if(!row) return;
      const id = row.getAttribute('data-item-id');

      if(e.target.classList.contains('qty-inc')){
        const input = row.querySelector('input');
        input.value = Math.max(0, parseInt(input.value||'0', 10) + 1);
        recalc();
        await fetch(`/api/cart/item/${id}/set-qty/`, {
          method:'POST', headers:{'Content-Type':'application/json','X-CSRFToken':csrftoken},
          body: JSON.stringify({qty: parseInt(input.value, 10)})
        });
      } else if(e.target.classList.contains('qty-dec')){
        const input = row.querySelector('input');
        input.value = Math.max(0, parseInt(input.value||'0', 10) - 1);
        recalc();
        const qty = parseInt(input.value, 10);
        await fetch(`/api/cart/item/${id}/set-qty/`, {
          method:'POST', headers:{'Content-Type':'application/json','X-CSRFToken':csrftoken},
          body: JSON.stringify({qty})
        });
        if(qty===0){ row.remove(); recalc(); }
      } else if(e.target.classList.contains('del')){
        row.remove();
        recalc();
        await fetch(`/api/cart/item/${id}/delete/`, {
          method:'POST', headers:{'X-CSRFToken':csrftoken}
        });
      }
    });

    // Also recalc if a qty input is manually edited then blurred
    itemsRoot.addEventListener('change', async (e)=>{
      const row = e.target.closest('[data-item-id]');
      if(!row || e.target.tagName !== 'INPUT') return;
      const id = row.getAttribute('data-item-id');
      const qty = Math.max(0, parseInt(e.target.value || '0', 10));
      e.target.value = qty;
      recalc();
      await fetch(`/api/cart/item/${id}/set-qty/`, {
        method:'POST', headers:{'Content-Type':'application/json','X-CSRFToken':csrftoken},
        body: JSON.stringify({qty})
      });
      if(qty===0){ row.remove(); recalc(); }
    });

    // Pay button (only rendered for signed-in users)
    if (payBtn){
      payBtn.onclick = async ()=>{
        msg.textContent='';
        if (cartIsEmpty()){
          msg.textContent = 'Your cart is empty. Add items to continue.';
          return;
        }

        const fulfillment = currentFulfillment();
        const payload = { fulfillment, address: {}, notes: '' };

        if(fulfillment==='delivery'){
          const name = document.getElementById('name').value.trim();
          const phone = document.getElementById('phone').value.trim();
          const line1 = document.getElementById('line1').value.trim();
          const line2 = document.getElementById('line2').value.trim();
          const city = document.getElementById('city').value.trim();
          const state = document.getElementById('state').value.trim();
          const postal_code = document.getElementById('postal').value.trim();
          const notes = document.getElementById('notes').value.trim();
          if(!name||!phone||!line1||!city||!state||!postal_code){
            msg.textContent = 'Please complete delivery address.';
            return;
          }
          payload.address = {name, phone, line1, line2, city, state, postal_code};
          payload.notes = notes;
        }

        try{
          const r = await fetch('/api/create-checkout-session/', {
            method:'POST',
            headers:{'Content-Type':'application/json','X-CSRFToken':csrftoken},
            credentials: 'same-origin',
            body: JSON.stringify(payload)
          });

          const text = await r.text();
          let j = {};
          try { j = text ? JSON.parse(text) : {}; } catch {}

          if (r.status === 401 || j.error === 'login_required'){
            msg.textContent = 'Please sign in to pay.';
            return;
          }
          if (r.status === 400 && (j.error === 'empty_cart' || /cart is empty/i.test(j.message || ''))){
            msg.textContent = 'Your cart is empty. Add items to continue.';
            return;
          }
          if (!r.ok){
            msg.textContent = j.message || 'Could not start checkout.';
            return;
          }

          if(j.checkout_url){
            // Redirect now
            window.location.href = j.checkout_url;
            // Also show QR/link for users who prefer to scan/open on phone
            const enc = encodeURIComponent(j.checkout_url);
            const qr = document.getElementById('qr');
            if (qr) qr.src = '/qr/?u='+enc;
            const link = document.getElementById('checkout-link');
            if (link){ link.href = j.checkout_url; link.textContent = 'Open Checkout'; }
          } else {
            msg.textContent = 'Unexpected response from server.';
          }
        } catch(e){
          console.error(e); msg.textContent = 'Network error.';
        }
      };
    }

    // Initial calc + disable state
    recalc();
  </script>
</body>
</html>