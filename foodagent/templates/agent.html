{% load static %}
{% load socialaccount %}
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>OSU Dining Agent ‚Ä¢ Stillwater</title>
  <meta name="description" content="Chat with the OSU Dining Agent to get menu suggestions and add/order exact items by ID (voice or text)."/>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="icon" href="{% static 'favicon.ico' %}"/>
  <style>
    :root{ --osu-orange:#f97316; --ink:#0b0b0b; }
    .bubble { border-radius: 1rem; padding:.6rem .8rem; font-size:.92rem; }
    .bubble-bot { background:#f3f4f6; color:#111827; }
    .bubble-user { background:var(--osu-orange); color:white; }
    .typing { display:inline-flex; gap:4px; }
    .typing > i { width:6px; height:6px; border-radius:999px; background:#9ca3af; opacity:.5; animation:t 1.3s infinite; }
    .typing > i:nth-child(2){ animation-delay:.15s }
    .typing > i:nth-child(3){ animation-delay:.3s }
    @keyframes t { 0%,100%{ transform:translateY(0) } 50%{ transform:translateY(-3px) } }
    .item-pill { border:1px solid #e5e7eb; border-radius:1rem; padding:.6rem; }
    .btn { border-radius:.8rem; padding:.5rem .8rem; }
    .btn-dark{ background:#111827; color:white; }
    .btn-ghost{ background:white; border:1px solid #e5e7eb; }
    .hdr-grad { background: linear-gradient(135deg, #111827 0%, #1f2937 45%, var(--osu-orange) 120%); color:white; }

    /* Web Search toggle */
    .switch { position: relative; width: 56px; height: 28px; background:#e5e7eb; border-radius:999px; transition:.2s; }
    .switch:after { content:''; position:absolute; top:3px; left:3px; width:22px; height:22px; background:white; border-radius:999px; transition:.2s; box-shadow:0 2px 8px rgba(0,0,0,.15); }
    input:checked + .switch { background:#16a34a; }
    input:checked + .switch:after { transform: translateX(28px); }
  </style>
</head>
<body class="bg-gradient-to-b from-amber-50 to-white text-gray-900">
  <!-- NAV -->
  <header class="sticky top-0 z-40 bg-white/70 backdrop-blur border-b">
    <div class="max-w-5xl mx-auto px-4 py-3 flex items-center justify-between">
      <button type="button"
              class="px-4 py-2 rounded-xl border hover:bg-gray-50"
              onclick="if (document.referrer) { window.history.back(); } else { window.location.href = '/'; }">
        ‚Üê
      </button>
      <a href="/" class="flex items-center gap-2 font-bold text-xl">
        <span class="inline-flex h-8 w-8 items-center justify-center rounded-xl bg-orange-600 text-white">üçΩÔ∏è</span>
        OSU Dining Agent
      </a>
      <div class="flex items-center gap-4">
        <a href="/cart/" class="relative text-sm px-3 py-2 rounded-xl bg-black text-white hover:opacity-90 flex items-center gap-2">
          üõí <span id="cart-count" class="inline-flex items-center justify-center w-5 h-5 rounded-full bg-orange-600 text-xs">0</span>
          <span class="hidden sm:inline">Cart</span>
        </a>
        <a href="/" class="text-sm px-3 py-2 rounded-xl border">Back to site</a>
      </div>
    </div>
  </header>

  <!-- Agent Shell -->
  <main class="max-w-5xl mx-auto px-4 py-6 grid lg:grid-cols-3 gap-6">
    <!-- Chat -->
    <section class="lg:col-span-2 bg-white rounded-2xl border overflow-hidden">
      <div class="hdr-grad h-14 px-4 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="font-bold">Dining Assistant</div>
          <span class="inline-flex items-center gap-1 text-xs opacity-90">
            <span class="inline-block w-2 h-2 rounded-full bg-green-400"></span> online
          </span>
        </div>
        <!-- Web Search toggle moved here (rightmost) -->
        <label class="flex items-center gap-2 text-xs sm:text-sm">
          <span class="opacity-90">Web Search</span>
          <input id="websearch-toggle" type="checkbox" class="hidden">
          <span class="switch cursor-pointer"></span>
        </label>
      </div>

      <!-- Chat body -->
      <div id="chat-body" class="h-[58vh] md:h-[62vh] overflow-y-auto p-3">
        <div class="p-1">
          <div class="bubble bubble-bot inline-block">
            Tell me what you‚Äôre craving (e.g., ‚Äúspicy vegan‚Äù, ‚Äúunder $12 bowls‚Äù).<br/>
            Add specific items by ID: <strong>‚Äúadd 23‚Äù</strong> or multiple: <strong>‚Äúadd 12 and 34‚Äù</strong>.<br/>
            Buy by ID: <strong>‚Äúorder 23‚Äù</strong>. Buy your cart: <strong>‚Äúorder items in the cart‚Äù</strong>.
          </div>
        </div>
        <div class="px-1 pb-2">
          <div class="flex flex-wrap gap-2">
            <button data-q="Recommend spicy vegan dishes" class="qchip px-3 py-1 rounded-full bg-white border text-sm">Spicy vegan dishes</button>
            <button data-q="Under $12 lunch bowls" class="qchip px-3 py-1 rounded-full bg-white border text-sm">Under $12 lunch bowls</button>
            <button data-q="High-protein options" class="qchip px-3 py-1 rounded-full bg-white border text-sm">High-protein</button>
            <button data-q="Gluten-free pizza" class="qchip px-3 py-1 rounded-full bg-white border text-sm">Gluten-free pizza</button>
          </div>
        </div>
      </div>

      <!-- Composer with mic INSIDE the textbox -->
      <div class="h-22 border-t bg-white px-3 py-2">
        <div class="relative">
          <input id="chat-input"
                 class="w-full border rounded-xl pl-3 pr-12 py-2 outline-none focus:ring-2 focus:ring-orange-500"
                 placeholder="Type or use the mic‚Ä¶"
                 autocomplete="off"/>
          <!-- Mic button inside input -->
          <button type="button" id="mic-btn"
                  class="absolute right-2 top-1/2 -translate-y-1/2 px-2 py-1 rounded-lg border text-sm"
                  title="Voice input">üéôÔ∏è</button>
        </div>
      </div>
    </section>

    <!-- Side panel -->
    <aside class="space-y-4">
      <div class="bg-white rounded-2xl border p-4">
        <div class="font-semibold">Mini Cart</div>
        <div id="mini" class="text-sm text-gray-600 mt-2">Items will appear as you add them.</div>
        <div class="mt-3 flex items-center gap-2">
          <a href="/cart/" class="btn btn-ghost border w-full text-center">View cart</a>
          <button id="checkout" class="btn btn-dark w-full">Checkout</button>
        </div>
      </div>

      <div class="bg-white rounded-2xl border p-4">
        <div class="font-semibold">Tips</div>
        <ul class="list-disc pl-5 text-sm text-gray-700 mt-2 space-y-1">
          <li>Suggestions show <strong>ID</strong>. Say ‚Äúadd &lt;ID&gt;‚Äù to add by voice.</li>
          <li>Buy instantly: ‚Äúorder &lt;ID&gt;‚Äù or ‚Äúorder 12 and 37‚Äù.</li>
          <li>Buy your cart: ‚Äúorder items in the cart‚Äù or ‚Äúcheckout‚Äù.</li>
        </ul>
      </div>
    </aside>
  </main>

  <!-- Order Progress Modal -->
  <div id="flow" class="fixed inset-0 z-[90] hidden">
    <div class="absolute inset-0 bg-black/40"></div>
    <div class="relative max-w-md mx-auto mt-24 bg-white rounded-2xl shadow-2xl border">
      <div class="p-4 border-b flex items-center justify-between">
        <div class="font-semibold">Processing your order‚Ä¶</div>
        <button id="flow-close" class="text-gray-500 hover:text-black">‚úï</button>
      </div>
      <div class="p-4">
        <ol class="space-y-3 text-sm">
          <li id="flow-step-add" class="flex items-center gap-2">
            <span class="step-dot w-2 h-2 rounded-full bg-gray-300"></span>
            Adding item(s) to cart
          </li>
          <li id="flow-step-pay" class="flex items-center gap-2">
            <span class="step-dot w-2 h-2 rounded-full bg-gray-300"></span>
            Creating secure payment
          </li>
          <li id="flow-step-redirect" class="flex items-center gap-2">
            <span class="step-dot w-2 h-2 rounded-full bg-gray-300"></span>
            Redirecting to checkout
          </li>
        </ol>
        <ul id="flow-items" class="mt-3 text-sm text-gray-700 space-y-1"></ul>
        <div id="flow-login" class="mt-4 hidden">
          <div class="text-sm text-gray-700">You need to sign in before paying.</div>
          <div class="mt-2 flex items-center gap-2">
            <a href="{% provider_login_url 'google' %}" class="inline-flex items-center px-3 py-2 rounded-xl border">
              <img src="https://www.svgrepo.com/media/cache/256/6f/3a/6f3a727a5e9f5fc8a908233f9d5c9b86.png" width="16" height="16" class="mr-2" alt="">
              Continue with Google
            </a>
            <a href="/accounts/login/" class="text-sm underline">Use email</a>
          </div>
        </div>
        <div id="flow-error" class="mt-3 text-sm text-red-600 hidden"></div>
        <div class="mt-4 text-xs text-gray-500">Don‚Äôt close this window‚Äîyour payment opens in a moment.</div>
      </div>
    </div>
  </div>

  <script>
    // ---- Helpers & globals ----
    function getCookie(name){ return document.cookie.split('; ').find(r => r.startsWith(name+'='))?.split('=')[1]; }
    const csrftoken = getCookie('csrftoken');
    const cartCount = document.getElementById('cart-count');
    const mini = document.getElementById('mini');
    const chatBody = document.getElementById('chat-body');

    // Web Search page toggle (in header)
    const webToggle = document.getElementById('websearch-toggle');
    webToggle.addEventListener('change', ()=> { if (webToggle.checked) window.location.href = "/websearch/"; });

    function pushMsg(role, text){
      const wrap = document.createElement('div');
      wrap.className = 'p-2 ' + (role === 'user' ? 'text-right' : 'text-left');
      const bubble = document.createElement('div');
      bubble.className = 'bubble ' + (role === 'user' ? 'bubble-user' : 'bubble-bot');
      bubble.textContent = text;
      wrap.appendChild(bubble);
      chatBody.appendChild(wrap);
      chatBody.scrollTop = chatBody.scrollHeight;
    }
    function showTyping(){
      const el = document.createElement('div'); el.id='typing'; el.className='p-2';
      el.innerHTML = `<div class="bubble bubble-bot inline-block"><span class="typing"><i></i><i></i><i></i></span></div>`;
      chatBody.appendChild(el); chatBody.scrollTop = chatBody.scrollHeight;
    }
    function hideTyping(){ document.getElementById('typing')?.remove(); }

    // ---- Voice In (mic inside textbox) ----
    const micBtn = document.getElementById('mic-btn');
    let rec = null, listening=false, voiceHandled=false;
    function initRec(){
      const Ctor = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!Ctor) return null;
      const r=new Ctor(); r.lang='en-US'; r.continuous=false; r.interimResults=false;
      r.onresult = (ev)=>{
        if (voiceHandled) return;
        voiceHandled = true; // avoid duplicate
        const t=ev.results?.[0]?.[0]?.transcript;
        if(t){ document.getElementById('chat-input').value=t; handleSend(); }
        r.stop();
      };
      r.onend = ()=>{ listening=false; voiceHandled=false; };
      return r;
    }
    micBtn.addEventListener('click', ()=>{
      if(!rec) rec=initRec();
      if(!rec){ alert('Voice input not supported by this browser.'); return; }
      if(!listening){ listening=true; rec.start(); } else { rec.stop(); }
    });

    // ---- Cart helpers ----
    async function refreshCart(){
      try{
        const r = await fetch('/api/cart/', {credentials:'same-origin'});
        const j = await r.json();
        const n = (j.items||[]).reduce((s,it)=>s+(it.qty||0),0);
        cartCount.textContent = n;
        if (!j.items?.length){ mini.textContent = 'Items will appear as you add them.'; return; }
        mini.innerHTML = j.items.map(it => `<div class="flex items-center justify-between">
            <span>#${it.menu_item.id} ‚Äî ${it.menu_item.name} √ó ${it.qty}</span>
            <span class="text-gray-600">$${Number(it.menu_item.price).toFixed(2)}</span>
          </div>`).join('');
      }catch(e){ console.error(e); }
    }

    // ---- Order flow modal helpers ----
    const flowEl    = document.getElementById('flow');
    const flowClose = document.getElementById('flow-close');
    const stepAdd   = document.querySelector('#flow-step-add .step-dot');
    const stepPay   = document.querySelector('#flow-step-pay .step-dot');
    const stepGo    = document.querySelector('#flow-step-redirect .step-dot');
    const flowItems = document.getElementById('flow-items');
    const flowLogin = document.getElementById('flow-login');
    const flowErr   = document.getElementById('flow-error');

    function stepState(dot, state){
      if(!dot) return;
      dot.classList.remove('active','done','error','bg-gray-300');
      if(state==='active') dot.classList.add('active');
      if(state==='done')   dot.classList.add('done');
      if(state==='error')  dot.classList.add('error');
    }
    function flowReset(){
      [stepAdd, stepPay, stepGo].forEach(d=>{ if(!d) return; d.className='step-dot w-2 h-2 rounded-full bg-gray-300'; });
      if(flowErr){ flowErr.classList.add('hidden'); flowErr.textContent=''; }
      flowLogin?.classList.add('hidden');
      if(flowItems) flowItems.innerHTML='';
    }
    function flowOpen(){ flowReset(); flowEl?.classList.remove('hidden'); }
    function flowHide(){ flowEl?.classList.add('hidden'); }
    flowClose?.addEventListener('click', flowHide);
    function showFlowError(msg){ if(flowErr){ flowErr.textContent=msg; flowErr.classList.remove('hidden'); } }
    function requireLoginInFlow(){ stepState(stepPay,'error'); flowLogin?.classList.remove('hidden'); }

    // ---- Suggestions UI (shows ID) ----
    function renderSuggestionList(items){
      if(!items?.length) return;
      const wrap = document.createElement('div'); wrap.className='p-2 text-left';
      const grid = document.createElement('div'); grid.className='grid gap-2';
      items.forEach(x=>{
        const el = document.createElement('div');
        el.className = 'item-pill flex items-center justify-between';
        el.innerHTML = `
          <div>
            <div class="font-semibold">#${x.id} ‚Äî ${x.name}</div>
            <div class="text-xs text-gray-500">$${Number(x.price).toFixed(2)}</div>
          </div>
          <div class="flex items-center gap-2">
            <button class="btn btn-ghost text-xs" data-view="${x.id}">Details</button>
            <button class="btn btn-dark text-xs" data-add="${x.id}">Add</button>
          </div>`;
        grid.appendChild(el);
      });
      wrap.appendChild(grid);
      chatBody.appendChild(wrap);
      chatBody.scrollTop = chatBody.scrollHeight;

      wrap.querySelectorAll('[data-add]').forEach(b=>{
        b.addEventListener('click', async ()=>{
          if(b.disabled) return; b.disabled=true;
          try{
            const id = Number(b.getAttribute('data-add'));
            await addItemToCart(id);
            pushMsg('bot',`Added #${id} to cart.`);
            refreshCart();
          } finally { setTimeout(()=>b.disabled=false,600); }
        });
      });
    }

    // ---- Add-to-cart helpers ----
    async function addItemToCart(id, qty=1){
      const r = await fetch('/api/cart/', {
        method:'POST',
        headers:{'Content-Type':'application/json','X-CSRFToken': csrftoken},
        credentials:'same-origin',
        body: JSON.stringify({menu_item:id, qty:qty})
      });
      if (r.status === 401){ requireLoginInFlow(); throw new Error('login'); }
      if (!r.ok) throw new Error('add-failed');
      return r.json().catch(()=> ({}));
    }
    async function addItemsToCart(ids){
      const added=[]; for(const id of ids){ try{ await addItemToCart(id); added.push(id);}catch(e){} }
      return added;
    }

    // ---- Checkout helper ----
    async function startCheckout(){
      stepState(stepPay,'active');
      const r = await fetch('/api/create-checkout-session/', {
        method:'POST',
        headers:{'Content-Type':'application/json','X-CSRFToken':csrftoken},
        credentials:'same-origin',
        body: JSON.stringify({})
      });
      const txt = await r.text(); let j={}; try{ j = txt ? JSON.parse(txt) : {}; }catch{}
      if(r.status===401){ requireLoginInFlow(); pushMsg('bot','Please sign in to proceed to payment.'); return; }
      if(!r.ok || !j.checkout_url){ stepState(stepPay,'error'); showFlowError(j.error || 'Could not create payment session.'); pushMsg('bot','Payment couldn‚Äôt be started.'); return; }
      stepState(stepPay,'done'); stepState(stepGo,'active');
      window.location.href = j.checkout_url;
    }

    // Command parsing
    const ORDER_CART_RX = /(order|checkout).*(cart|items)/i;
    const ORDER_IDS_RX  = /\border\b/i;     // requires ids
    const ADD_IDS_RX    = /\b(add|buy|get)\b/i;

    const PRICE_PHRASE_RX = /(under|below|less\s*than|<=?)\s*\$?\s*\d+(?:\.\d{1,2})?/ig;
    function parseIds(text){
      // strip price phrases so numbers like "under $12" don't look like IDs
      const s = String(text||'').replace(PRICE_PHRASE_RX,'');
      return [...s.matchAll(/#?\b(\d{1,6})\b/g)].map(m=>Number(m[1])).filter(Boolean);
    }

    // ---- Chat send logic ----
    let inFlight = false;
    async function handleSend(){
      if(inFlight) return;
      const input = document.getElementById('chat-input');
      const msg = (input.value||'').trim();
      if(!msg) return;
      pushMsg('user', msg);
      input.value='';

      // 1) Order existing cart
      if (ORDER_CART_RX.test(msg) || /^checkout$/i.test(msg)){
        showTyping(); inFlight = true;
        try{
          flowOpen(); stepState(stepAdd,'done'); // nothing to add
          await startCheckout();
        } finally { hideTyping(); setTimeout(()=>{ inFlight=false; }, 300); }
        return;
      }

      // 2) Order by ID(s): add then checkout
      if (ORDER_IDS_RX.test(msg)){
        const ids = parseIds(msg);
        if (ids.length){
          showTyping(); inFlight = true;
          try{
            flowOpen(); stepState(stepAdd,'active');
            const added = await addItemsToCart(ids);
            if (added.length){
              stepState(stepAdd,'done');
              flowItems.innerHTML = added.map(i=>`<li>‚Ä¢ Item #${i} added</li>`).join('');
              pushMsg('bot', `Added ${added.map(i=>`#${i}`).join(', ')}. Proceeding to checkout‚Ä¶`);
              await startCheckout();
              return;
            } else {
              stepState(stepAdd,'error'); showFlowError('Could not add the requested item(s).');
              pushMsg('bot','Could not add the requested item(s).');
            }
          } finally { hideTyping(); setTimeout(()=>{ inFlight=false; }, 400); }
          return;
        }
      }

      // 3) Add by ID(s): add only
      if (ADD_IDS_RX.test(msg)){
        const ids = parseIds(msg);
        if (ids.length){
          showTyping(); inFlight = true;
          try{
            const added = await addItemsToCart(ids);
            hideTyping();
            if (added.length){
              pushMsg('bot', `Added ${added.map(i=>`#${i}`).join(', ')} to cart.`);
              refreshCart();
            } else {
              pushMsg('bot','Could not add the requested item(s). Check IDs and try again.');
            }
          } finally { setTimeout(()=>{ inFlight=false; }, 300); }
          return;
        }
      }

      // 4) Otherwise: suggestions
      showTyping(); inFlight = true;
      try{
        const r = await fetch('/api/agent/', {
          method:'POST',
          headers:{'Content-Type':'application/json','X-CSRFToken':csrftoken},
          credentials:'same-origin',
          body: JSON.stringify({message: msg})
        });
        const txt = await r.text(); let j={}; try{ j = txt ? JSON.parse(txt) : {}; }catch{}
        hideTyping();

        if(!r.ok){ pushMsg('bot','Sorry‚Äîsomething went wrong.'); return; }
        if(j.suggestions?.length){
          pushMsg('bot','You might like these:');
          renderSuggestionList(j.suggestions);
        } else {
          pushMsg('bot', j.reply || "Tell me a flavor, diet, or price range and I‚Äôll suggest dishes.");
        }
        if(j.follow_up) pushMsg('bot', j.follow_up);
        refreshCart();
      }catch(e){
        hideTyping(); console.error(e); pushMsg('bot','Network error. Please try again.');
      }finally{
        setTimeout(()=>{ inFlight=false; }, 600);
      }
    }

    // Send button (not visible now; we auto-send via chips or Enter)
    document.getElementById('chat-input').addEventListener('keydown', e=>{
      if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); handleSend(); }
    });

    // Chips: auto-send immediately (no manual button)
    document.querySelectorAll('.qchip').forEach(b=> b.addEventListener('click', ()=>{
      const v = b.dataset.q || b.textContent;
      document.getElementById('chat-input').value = v;
      handleSend(); // auto-trigger
    }));

    // Manual checkout button
    document.getElementById('checkout').addEventListener('click', async ()=>{
      flowOpen(); stepState(stepAdd,'done'); stepState(stepPay,'active');
      try{
        const r = await fetch('/api/create-checkout-session/', {
          method:'POST',
          headers:{'Content-Type':'application/json','X-CSRFToken':csrftoken},
          credentials:'same-origin',
          body: JSON.stringify({})
        });
        const txt = await r.text(); let j={}; try{ j = txt ? JSON.parse(txt) : {}; }catch{}
        if(r.status===401){ requireLoginInFlow(); pushMsg('bot','Please sign in to pay.'); return; }
        if(!r.ok || !j.checkout_url){ stepState(stepPay,'error'); showFlowError(j.error || 'Unable to start checkout'); return; }
        stepState(stepPay,'done'); stepState(stepGo,'active'); window.location.href = j.checkout_url;
      }catch(e){ console.error(e); stepState(stepPay,'error'); showFlowError('Network error.'); }
    });

    // Init
    (async ()=>{ try{ await refreshCart(); }catch(_){} })();
  </script>
</body>
</html>