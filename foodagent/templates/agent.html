{% load static %}
{% load socialaccount %}
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>OSU Dining Agent ‚Ä¢ Stillwater</title>
  <meta name="description" content="Chat with the OSU Dining Agent to get recommendations and place orders automatically."/>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="icon" href="{% static 'favicon.ico' %}"/>
  <style>
    :root{ --osu-orange:#f97316; --ink:#0b0b0b; }
    .bubble { border-radius: 1rem; padding:.6rem .8rem; font-size:.92rem; }
    .bubble-bot { background:#f3f4f6; color:#111827; }
    .bubble-user { background:var(--osu-orange); color:white; }
    .typing { display:inline-flex; gap:4px; }
    .typing > i { width:6px; height:6px; border-radius:999px; background:#9ca3af; opacity:.5; animation:t 1.3s infinite; }
    .typing > i:nth-child(2){ animation-delay:.15s }
    .typing > i:nth-child(3){ animation-delay:.3s }
    @keyframes t { 0%,100%{ transform:translateY(0) } 50%{ transform:translateY(-3px) } }
    .item-pill { border:1px solid #e5e7eb; border-radius:1rem; padding:.6rem; }
    .btn { border-radius:.8rem; padding:.5rem .8rem; }
    .btn-dark{ background:#111827; color:white; }
    .btn-ghost{ background:white; border:1px solid #e5e7eb; }
    .hdr-grad { background: linear-gradient(135deg, #111827 0%, #1f2937 45%, var(--osu-orange) 120%); color:white; }
    .shadow-elev { box-shadow: 0 15px 40px rgba(0,0,0,.08); }
    .step-dot.active { background:#f59e0b }  /* amber */
    .step-dot.done   { background:#16a34a }  /* green */
    .step-dot.error  { background:#dc2626 }  /* red */
  </style>
</head>
<body class="bg-gradient-to-b from-amber-50 to-white text-gray-900">
  <!-- NAV -->
  <header class="sticky top-0 z-40 bg-white/70 backdrop-blur border-b">
    <div class="max-w-5xl mx-auto px-4 py-3 flex items-center justify-between">
      <button type="button"
          class="px-4 py-2 rounded-xl border hover:bg-gray-50"
          onclick="if (document.referrer) { window.history.back(); } else { window.location.href = '/'; }">
    ‚Üê
  </button>
      <a href="/" class="flex items-center gap-2 font-bold text-xl">
        <span class="inline-flex h-8 w-8 items-center justify-center rounded-xl bg-orange-600 text-white">üçΩÔ∏è</span>
        OSU Dining Agent
      </a>
      <div class="flex items-center gap-2">
        <a href="/cart/" class="relative text-sm px-3 py-2 rounded-xl bg-black text-white hover:opacity-90 flex items-center gap-2">
          üõí <span id="cart-count" class="inline-flex items-center justify-center w-5 h-5 rounded-full bg-orange-600 text-xs">0</span>
          <span class="hidden sm:inline">Cart</span>
        </a>
        <a href="/" class="text-sm px-3 py-2 rounded-xl border">Back to site</a>
      </div>
    </div>
  </header>

  <!-- Agent Shell -->
  <main class="max-w-5xl mx-auto px-4 py-6 grid lg:grid-cols-3 gap-6">
    <!-- Chat -->
    <section class="lg:col-span-2 bg-white rounded-2xl border shadow-elev">
      <div class="hdr-grad h-14 px-4 flex items-center justify-between rounded-t-2xl">
        <div class="flex items-center gap-3">
          <div class="font-bold">Dining Assistant</div>
          <span class="inline-flex items-center gap-1 text-xs opacity-90">
            <span class="inline-block w-2 h-2 rounded-full bg-green-400"></span> online
          </span>
        </div>
        <div class="flex items-center gap-2">
          <label class="text-xs inline-flex items-center gap-1"><input type="checkbox" id="auto-order"> Auto-order</label>
          <label class="text-xs inline-flex items-center gap-1"><input type="checkbox" id="speak-replies"> üîä Speak</label>
        </div>
      </div>

      <div id="chat-body" class="h-[60vh] md:h-[64vh] overflow-y-auto p-3">
        <div class="p-1">
          <div class="bubble bubble-bot inline-block">
            Hi! Tell me what you‚Äôre craving (e.g., ‚Äúspicy vegan‚Äù, ‚Äúunder $12 bowls‚Äù). Say ‚Äúorder‚Äù to add.
          </div>
        </div>
        <div class="px-1 pb-2">
          <div class="flex flex-wrap gap-2">
            <button data-q="Recommend spicy vegan dishes" class="qchip px-3 py-1 rounded-full bg-white border text-sm">Spicy vegan dishes</button>
            <button data-q="Under $12 lunch bowls" class="qchip px-3 py-1 rounded-full bg-white border text-sm">Under $12 bowls</button>
            <button data-q="High-protein options" class="qchip px-3 py-1 rounded-full bg-white border text-sm">High-protein</button>
            <button data-q="Gluten-free pizza" class="qchip px-3 py-1 rounded-full bg-white border text-sm">Gluten-free pizza</button>
          </div>
        </div>
      </div>

      <div class="h-22 border-t bg-white px-3 py-2 flex items-center gap-2 rounded-b-2xl">
        <button type="button" id="mic-btn" class="px-3 py-2 rounded-xl border" title="Voice input">üéôÔ∏è</button>
        <input id="chat-input" class="flex-1 border rounded-xl px-3 py-2 outline-none focus:ring-2 focus:ring-orange-500" placeholder="Type or use the mic‚Ä¶" autocomplete="off"/>
        <button id="chat-send" class="btn btn-dark">Send</button>
      </div>
    </section>

    <!-- Side panel -->
    <aside class="space-y-4">
      <div class="bg-white rounded-2xl border p-4">
        <div class="font-semibold">Mini Cart</div>
        <div id="mini" class="text-sm text-gray-600 mt-2">Items will appear as you add them.</div>
        <div class="mt-3 flex items-center gap-2">
          <a href="/cart/" class="btn btn-ghost border w-full text-center">View cart</a>
          <button id="checkout" class="btn btn-dark w-full">Checkout</button>
        </div>
      </div>

      <div class="bg-white rounded-2xl border p-4">
        <div class="font-semibold">Tips</div>
        <ul class="list-disc pl-5 text-sm text-gray-700 mt-2 space-y-1">
          <li>Say ‚Äúorder‚Äù to automatically add the top result and start checkout.</li>
          <li>Use price or diet filters: ‚Äúunder $12‚Äù, ‚Äúhalal‚Äù, ‚Äúvegan high protein‚Äù.</li>
          <li>Turn on <em>Auto-order</em> to always add & pay.</li>
        </ul>
      </div>
    </aside>
  </main>

  <!-- Order Progress Modal -->
  <div id="flow" class="fixed inset-0 z-[90] hidden">
    <div class="absolute inset-0 bg-black/40"></div>
    <div class="relative max-w-md mx-auto mt-24 bg-white rounded-2xl shadow-2xl border">
      <div class="p-4 border-b flex items-center justify-between">
        <div class="font-semibold">Placing your order‚Ä¶</div>
        <button id="flow-close" class="text-gray-500 hover:text-black">‚úï</button>
      </div>
      <div class="p-4">
        <ol class="space-y-3 text-sm">
          <li id="flow-step-add" class="flex items-center gap-2">
            <span class="step-dot w-2 h-2 rounded-full bg-gray-300"></span>
            Adding items to cart
          </li>
          <li id="flow-step-pay" class="flex items-center gap-2">
            <span class="step-dot w-2 h-2 rounded-full bg-gray-300"></span>
            Creating secure payment
          </li>
          <li id="flow-step-redirect" class="flex items-center gap-2">
            <span class="step-dot w-2 h-2 rounded-full bg-gray-300"></span>
            Redirecting to checkout
          </li>
        </ol>
        <ul id="flow-items" class="mt-3 text-sm text-gray-700 space-y-1"></ul>
        <div id="flow-login" class="mt-4 hidden">
          <div class="text-sm text-gray-700">You need to sign in before paying.</div>
          <div class="mt-2 flex items-center gap-2">
            <a href="{% provider_login_url 'google' %}"
               class="inline-flex items-center px-3 py-2 rounded-xl border">
              <img src="https://www.svgrepo.com/media/cache/256/6f/3a/6f3a727a5e9f5fc8a908233f9d5c9b86.png" width="16" height="16" class="mr-2" alt=""> Continue with Google
            </a>
            <a href="/accounts/login/" class="text-sm underline">Use email</a>
          </div>
        </div>
        <div id="flow-error" class="mt-3 text-sm text-red-600 hidden"></div>
        <div class="mt-4 text-xs text-gray-500">Don‚Äôt close this window‚Äîyour payment opens in a moment.</div>
      </div>
    </div>
  </div>

  <script>
    // ---- Helpers & globals ----
    function getCookie(name){ return document.cookie.split('; ').find(r => r.startsWith(name+'='))?.split('=')[1]; }
    const csrftoken = getCookie('csrftoken');
    const cartCount = document.getElementById('cart-count');
    const mini = document.getElementById('mini');

    function pushMsg(role, text){
      const body = document.getElementById('chat-body');
      const wrap = document.createElement('div');
      wrap.className = 'p-2 ' + (role === 'user' ? 'text-right' : 'text-left');
      const bubble = document.createElement('div');
      bubble.className = 'bubble ' + (role === 'user' ? 'bubble-user' : 'bubble-bot');
      bubble.textContent = text;
      wrap.appendChild(bubble);
      body.appendChild(wrap);
      body.scrollTop = body.scrollHeight;
      if (role === 'bot') speak(text);
    }
    function showTyping(){
      const body = document.getElementById('chat-body');
      const el = document.createElement('div'); el.id='typing'; el.className='p-2';
      el.innerHTML = `<div class="bubble bubble-bot inline-block"><span class="typing"><i></i><i></i><i></i></span></div>`;
      body.appendChild(el); body.scrollTop = body.scrollHeight;
    }
    function hideTyping(){ document.getElementById('typing')?.remove(); }

    // ---- Voice In / TTS ----
    const speakEl = document.getElementById('speak-replies');
    function speak(text){ try{ if(!speakEl.checked) return; const u=new SpeechSynthesisUtterance(text); speechSynthesis.cancel(); speechSynthesis.speak(u);}catch{} }
    const micBtn = document.getElementById('mic-btn');
    let rec = null, listening=false;
    function initRec(){
      const Ctor = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!Ctor) return null;
      const r=new Ctor(); r.lang='en-US'; r.continuous=false; r.interimResults=false;
      r.onresult = (ev)=>{ const t=ev.results?.[0]?.[0]?.transcript; if(t){ document.getElementById('chat-input').value=t; document.getElementById('chat-send').click(); }};
      r.onend = ()=>{ listening=false; micBtn.textContent='üéôÔ∏è'; };
      return r;
    }
    micBtn.addEventListener('click', ()=>{
      if(!rec) rec=initRec();
      if(!rec){ alert('Voice input not supported by this browser.'); return; }
      if(!listening){ listening=true; micBtn.textContent='‚èπÔ∏è'; rec.start(); } else { rec.stop(); }
    });

    // ---- Cart helpers ----
    async function refreshCart(){
      try{
        const r = await fetch('/api/cart/', {credentials:'same-origin'});
        const j = await r.json();
        const n = (j.items||[]).reduce((s,it)=>s+(it.qty||0),0);
        cartCount.textContent = n;
        if (!j.items?.length){ mini.textContent = 'Items will appear as you add them.'; return; }
        mini.innerHTML = j.items.map(it => `<div class="flex items-center justify-between">
            <span>${it.menu_item.name} √ó ${it.qty}</span>
            <span class="text-gray-600">$${Number(it.menu_item.price).toFixed(2)}</span>
          </div>`).join('');
      }catch(e){ console.error(e); }
    }

    // ---- Suggestions UI ----
    function renderSuggestionList(items, { readOnly = false } = {}){
      if(!items?.length) return;
      const body = document.getElementById('chat-body');
      const wrap = document.createElement('div'); wrap.className='p-2 text-left';
      const grid = document.createElement('div'); grid.className='grid gap-2';
      items.forEach(x=>{
        const el = document.createElement('div');
        el.className = 'item-pill flex items-center justify-between';
        el.innerHTML = `
          <div>
            <div class="font-semibold">${x.name}</div>
            <div class="text-xs text-gray-500">$${Number(x.price).toFixed(2)}</div>
          </div>
          <div class="flex items-center gap-2">
            <button class="btn btn-ghost text-xs" data-view="${x.id}">Details</button>
            ${readOnly ? '' : `<button class="btn btn-dark text-xs" data-add="${x.id}">Add</button>`}
          </div>`;
        grid.appendChild(el);
      });
      wrap.appendChild(grid);
      body.appendChild(wrap);
      body.scrollTop = body.scrollHeight;

      if(!readOnly){
        wrap.querySelectorAll('[data-add]').forEach(b=>{
          b.addEventListener('click', async ()=>{
            if(b.disabled) return; b.disabled=true;
            try{
              const id = Number(b.getAttribute('data-add'));
              await fetch('/api/cart/', {
                method:'POST',
                headers:{'Content-Type':'application/json','X-CSRFToken': csrftoken},
                credentials:'same-origin',
                body: JSON.stringify({menu_item:id, qty:1})
              });
              pushMsg('bot','Added to cart.');
              refreshCart();
            } finally { setTimeout(()=>b.disabled=false,600); }
          });
        });
      }
    }

    // ---- Order flow modal helpers ----
    const flowEl    = document.getElementById('flow');
    const flowClose = document.getElementById('flow-close');
    const stepAdd   = document.querySelector('#flow-step-add .step-dot');
    const stepPay   = document.querySelector('#flow-step-pay .step-dot');
    const stepGo    = document.querySelector('#flow-step-redirect .step-dot');
    const flowItems = document.getElementById('flow-items');
    const flowLogin = document.getElementById('flow-login');
    const flowErr   = document.getElementById('flow-error');

    function stepState(dot, state){
      if(!dot) return;
      dot.classList.remove('active','done','error','bg-gray-300');
      if(state==='active') dot.classList.add('active');
      if(state==='done')   dot.classList.add('done');
      if(state==='error')  dot.classList.add('error');
    }
    function flowReset(){
      [stepAdd, stepPay, stepGo].forEach(d=>{ if(!d) return; d.className='step-dot w-2 h-2 rounded-full bg-gray-300'; });
      if(flowErr){ flowErr.classList.add('hidden'); flowErr.textContent=''; }
      flowLogin?.classList.add('hidden');
      if(flowItems) flowItems.innerHTML='';
    }
    function flowOpen(){ flowReset(); flowEl?.classList.remove('hidden'); }
    function flowHide(){ flowEl?.classList.add('hidden'); }
    flowClose?.addEventListener('click', flowHide);
    function showFlowError(msg){ if(flowErr){ flowErr.textContent=msg; flowErr.classList.remove('hidden'); } }
    function requireLoginInFlow(){ stepState(stepPay,'error'); flowLogin?.classList.remove('hidden'); }

    // ---- Chat send logic ----
    const autoOrderEl = document.getElementById('auto-order');
    function wantsOrder(text){ return /\b(order now|place order|checkout|confirm order|confirm|order)\b/i.test(text.trim()); }

    let inFlight = false;
    async function handleSend(){
      if(inFlight) return;
      const input = document.getElementById('chat-input');
      const msg = (input.value||'').trim();
      if(!msg) return;
      pushMsg('user', msg);
      input.value='';

      const orderingFlow = autoOrderEl.checked || wantsOrder(msg);
      const url = orderingFlow ? '/api/agent/order/' : '/api/agent/';

      showTyping(); inFlight = true;
      try{
        if(orderingFlow){
          flowOpen();
          stepState(stepAdd,'active');

          // Add items first
          const addResp = await fetch(url, {
            method:'POST',
            headers:{'Content-Type':'application/json','X-CSRFToken':csrftoken},
            credentials:'same-origin',
            body: JSON.stringify({message: msg})
          });
          const addTxt = await addResp.text(); let add = {}; try{ add = addTxt ? JSON.parse(addTxt) : {}; }catch{}
          hideTyping();

          if(addResp.status === 401 || add.require_login){
            stepState(stepAdd,'done'); requireLoginInFlow();
            pushMsg('bot','Please sign in to continue to payment.');
            refreshCart(); return;
          }
          if(!addResp.ok){
            stepState(stepAdd,'error'); showFlowError('Could not add items. Please try again.');
            pushMsg('bot','Sorry‚Äîsomething went wrong adding items.');
            return;
          }
          stepState(stepAdd,'done');

          // Show items visibly
          if (add.added?.length){
            flowItems.innerHTML = add.added.map(x => `<li>‚Ä¢ ${x.name}</li>`).join('');
            const s = add.added.map(x=>`‚Ä¢ ${x.name}`).join('\n');
            pushMsg('bot', `Added to cart:\n${s}`);
          }
          if (add.suggestions?.length){
            pushMsg('bot','You might also like (not added):');
            renderSuggestionList(add.suggestions, { readOnly:true });
          }
          refreshCart();

          // If backend gives checkout_url, jump
          if(add.checkout_url){
            stepState(stepPay,'done'); stepState(stepGo,'active');
            window.location.href = add.checkout_url; return;
          }

          // Create checkout session
          stepState(stepPay,'active');
          const payResp = await fetch('/api/create-checkout-session/', {
            method:'POST',
            headers:{'Content-Type':'application/json','X-CSRFToken':csrftoken},
            credentials:'same-origin',
            body: JSON.stringify({})
          });
          const payTxt = await payResp.text(); let pay={}; try{ pay = payTxt ? JSON.parse(payTxt) : {}; }catch{}
          if(payResp.status===401){
            requireLoginInFlow(); pushMsg('bot','Please sign in to proceed to payment.'); refreshCart(); return;
          }
          if(!payResp.ok || !pay.checkout_url){
            stepState(stepPay,'error'); showFlowError(pay.error || 'Could not create payment session.');
            pushMsg('bot','Payment couldn‚Äôt be started. Try again.'); return;
          }
          stepState(stepPay,'done'); stepState(stepGo,'active');
          window.location.href = pay.checkout_url; return;
        }

        // Suggestions path
        const r = await fetch(url, {
          method:'POST',
          headers:{'Content-Type':'application/json','X-CSRFToken':csrftoken},
          credentials:'same-origin',
          body: JSON.stringify({message: msg})
        });
        const txt = await r.text(); let j={}; try{ j = txt ? JSON.parse(txt) : {}; }catch{}
        hideTyping();

        if(!r.ok){ pushMsg('bot','Sorry‚Äîsomething went wrong.'); return; }
        if(j.suggestions?.length){ pushMsg('bot','You might like these:'); renderSuggestionList(j.suggestions, {readOnly:false}); }
        else { pushMsg('bot', j.reply || "Tell me a flavor, diet, or price range and I‚Äôll suggest dishes."); }
        if(j.follow_up) pushMsg('bot', j.follow_up);
        refreshCart();
      }catch(e){
        hideTyping(); console.error(e); pushMsg('bot','Network error. Please try again.');
      }finally{
        setTimeout(()=>{ inFlight=false; }, 600);
      }
    }

    document.getElementById('chat-send').addEventListener('click', handleSend);
    document.getElementById('chat-input').addEventListener('keydown', e=>{
      if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); handleSend(); }
    });
    document.querySelectorAll('.qchip').forEach(b=> b.addEventListener('click', ()=>{
      document.getElementById('chat-input').value = b.dataset.q; document.getElementById('chat-input').focus();
    }));

    // Manual checkout button
    document.getElementById('checkout').addEventListener('click', async ()=>{
      // quick visual flow without adding
      flowOpen(); stepState(stepAdd,'done'); stepState(stepPay,'active');
      try{
        const r = await fetch('/api/create-checkout-session/', {
          method:'POST',
          headers:{'Content-Type':'application/json','X-CSRFToken':csrftoken},
          credentials:'same-origin',
          body: JSON.stringify({})
        });
        const txt = await r.text(); let j={}; try{ j = txt ? JSON.parse(txt) : {}; }catch{}
        if(r.status===401){ requireLoginInFlow(); pushMsg('bot','Please sign in to pay.'); return; }
        if(!r.ok || !j.checkout_url){ stepState(stepPay,'error'); showFlowError(j.error || 'Unable to start checkout'); return; }
        stepState(stepPay,'done'); stepState(stepGo,'active'); window.location.href = j.checkout_url;
      }catch(e){ console.error(e); stepState(stepPay,'error'); showFlowError('Network error.'); }
    });

    // Init
    refreshCart();
  </script>
</body>
</html>